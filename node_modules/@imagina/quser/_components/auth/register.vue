<template>
  <div id="formLoginComponent">
    <!-- Name field -->
    <q-field
      :error="$v.form.firstName.$error"
      error-label="Este campo es requerido"
    >
      <div class="input-title">
        <q-icon name="fas fa-user"/>
        Nombre *
      </div>
      <q-input name="username"
               autofocus
               autocomplete="off"
               v-model="form.firstName"
               type="text"
               color="blue-grey"
               @keyup.enter="register()"
      />
    </q-field>
    <!-- Last Name field -->
    <q-field
      :error="$v.form.lastName.$error"
      error-label="Este campo es requerido"
    >
      <div class="input-title">
        <q-icon name="fas fa-user-friends"/>
        Apellidos *
      </div>
      <q-input name="username"
               autocomplete="off"
               v-model="form.lastName"
               type="text"
               color="blue-grey"
               @keyup.enter="register()"
      />
    </q-field>
    <!-- Phone field -->
    <q-field
      :error="$v.form.fields.cellularPhone.value.$error"
      error-label="Debe contener al menos 10 digitos"
      :count="14"
    >
      <div class="input-title">
        <q-icon name="fas fa-phone"/>
        Teléfono *
      </div>
      <q-input v-model="form.fields.cellularPhone.value"
               @input="maskPhone" color="blue-grey"
               type="text" inputmode="numeric"
               pattern="[0-9]*" :maxlength="14"
               @keyup.enter="register()"
      />
    </q-field>
    <!-- Identification field -->
    <q-field
      :error="$v.form.fields.identification.value.$error"
      error-label="Este campo es requerido"
    >
      <div class="input-title">
        <q-icon name="fas fa-id-card"/>
        Cédula *
      </div>
      <q-input autocomplete="off"
               v-model="form.fields.identification.value"
               type="number"
               color="blue-grey"
               @keyup.enter="register()"
      />
    </q-field>
    <!-- Email field -->
    <q-field
      :error="$v.form.email.$error"
      error-label="Debe tener formato de e-mail"
    >
      <div class="input-title">
        <q-icon name="fas fa-at"/>
        Email *
      </div>
      <q-input name="username"
               autocomplete="off"
               v-model="form.email"
               type="text"
               color="blue-grey"
               @keyup.enter="register()"
      />
    </q-field>
    <!-- Password field -->
    <q-field
      :error="$v.form.password.$error"
      error-label="Debe contener al menos 8 digitos"
      :count="8"
    >
      <div class="input-title">
        <q-icon name="fas fa-lock"/>
        Contraseña *
      </div>
      <q-input v-model="form.password"
               type="password"
               name="password"
               color="blue-grey"
               @keyup.enter="register()"
      />
    </q-field>
    <!-- comfirm Password field -->
    <q-field
      :error="$v.form.passwordConfirmation.$error"
      error-label="No coincide con la contraseña"
      :count="8"
    >
      <div class="input-title">
        <q-icon name="fas fa-user-lock"/>
        Confirmar Contraseña *
      </div>
      <q-input v-model="form.passwordConfirmation"
               type="password"
               name="password"
               color="blue-grey"
               @keyup.enter="register()"
      />
    </q-field>
    <!--captcha-->
    <captcha v-model="form.captcha" ref="captcha" checkbox v-if="this.$q.platform.is.desktop"/>
    <!-- Button login -->
    <div class="text-center q-mt-sm">
      <q-btn :loading="loading"
             color="blue-grey" name="submit"
             @click="register()">
        Completar Registro
        <span slot="loading">
                <q-spinner-mat class="on-left"/>
                Registrando...
              </span>
      </q-btn>
    </div>
  </div>
</template>

<script>
  //Plugins
  import {required, email, sameAs, minLength} from 'vuelidate/lib/validators';
  import _cloneDeep from 'lodash.clonedeep'
  //services
  import authServices from '@imagina/quser/_services/profile/index'
  //components
  import captcha from '@imagina/qsite/_components/captcha'

  export default {
    components: {captcha},
    validations: {
      form: {
        firstName: {required},
        lastName: {required},
        email: {required, email},
        password: {required, minLength: minLength(8)},
        passwordConfirmation: {required, sameAsPassword: sameAs('password')},
        fields: {
          cellularPhone: {
            value : {required,minLength: minLength(14)}
          },
          identification: {
            value : {required}
          }
        }
      }
    },
    mounted() {
      this.$nextTick(function () {
      })
    },
    data() {
      return {
        loading: false,
        form: {
          firstName: null,
          lastName: null,
          email: null,
          password: null,
          passwordConfirmation: null,
          captcha: false,
          fields: {
            cellularPhone: {
              name : 'cellularPhone',
              value : null
            },
            identification: {
              name : 'identification',
              value : null
            }
          }
        },
      }
    },
    computed: {
      initData() {
        return {
          firstName: null,
          lastName: null,
          email: null,
          password: null,
          passwordConfirmation: null,
          fields: {
            cellularPhone: {
              name : 'cellularPhone',
              value : null
            },
            identification: {
              name : 'identification',
              value : null
            }
          }
        }
      }
    },
    methods: {
      //Login
      async register() {
        if (!this.inRequest) {
          this.$v.$touch();
          if (!this.$v.$error) {
            if (this.checkedCaptcha()) {
              this.loading = true;
              let data = this.$clone(this.form)
              data.fields = this.$helper.convertToBackField(this.form.fields)
              let apiRoute = this.$q.platform.is.android ? 'apiRoutes.profile.registerMobile' : 'apiRoutes.profile.register'
              authServices.crud.create(apiRoute, data).then(response => {
                this.callbackRequest(true, response.data)
              }).catch(error => {
                this.callbackRequest(false, error)
              })
            }
          } else {
            this.$helper.alert.error('Revise los campos inválidos', 'bottom')
          }
        }
      },
      //check if captcha is defined
      checkedCaptcha() {
        if(this.$q.platform.is.android){
          return  true
        }
        let captcha = this.form.captcha
        let response = false
        if (captcha && captcha.token) response = true
        if (!response) this.$helper.alert.error('El reCaptcha es requerido', 'bottom')
        return response
      },
      //Action after request
      callbackRequest(success = true, response) {
        this.$v.$reset()//Reset validations
        this.loading = false
        if(!this.$q.platform.is.android){
          this.$refs.captcha.reset()
        }
        let message = ''

        if (success) {
          //Message to activate user with email
          if (response.checkEmail)
            message = 'Debe activar su cuenta a través de su e-mail ' + this.form.email
          //Dialog to go to iniciar sesión when id register
          this.$q.dialog({
            title: 'Registro exitoso!',
            message: message,
            color: 'blue-grey',
            ok: 'Iniciar Sesion',
            cancel: false,
            noBackdropDismiss: true,
            noEscDismiss: true,
          }).then(async data => {
            this.$emit('registered', this.form.email)
            this.$emit('input', this.form.email)
            let captcha = _cloneDeep(this.form.captcha)
            this.form = _cloneDeep(this.initData)//inti form
            this.form.captcha = captcha
          }).catch(() => {
          })
        } else {
          console.error('[auth.register]', response)
          if (response) {//Message Vali
            let errorMsg = JSON.parse(response)
            if (errorMsg.email)
              this.$helper.alert.error(
                'El Email "' + this.form.email + '" ya está registrado',
                'top', false, 4000
              )
          }
        }
      },
      //Mask phone
      maskPhone() {
        this.$nextTick(() => {
          let phone = this.$clone(this.form.fields.cellularPhone.value)
          let maskedPhone = this.$helper.maskPhone(phone)
          this.form.fields.cellularPhone.value = this.$clone(maskedPhone)
        })
      }
    }
  }
</script>

<style lang="stylus">
  @import "~variables";
</style>
